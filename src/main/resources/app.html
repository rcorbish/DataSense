<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel='stylesheet' href='./css.css'>
<style>
</style> 

<title>zudat</title>
</head>
<body>
	<div id='menu-section' class='controls'>
		<div class="hamburger collapsible">
			<div class="collapsible bar1"></div>
			<div class="collapsible bar2"></div>
			<div class="collapsible bar3"></div>
		</div>

		<div id="menu" class="collapsible menu" >
			<div class="upload" data-target='upload-data'>Drop CSV</div>
			<form class='control' accept-charset="UTF-8" >
				<div class='menu-group'>
					<input type='checkbox' name='square-values'>Synthesize x<sup>2</sup>
					<input type='checkbox' name='log-values'>Synthesize log<sub>e</sub>( 1 + x<sup>2</sup> )
					<br/>
					<input type='checkbox' name='reciprocal'>Synthesize 1 / ( 1 + x )
					<input type='checkbox' name='discrete-to-col'>Discrete labels
					<br/>
					<input type='checkbox' name='keep-original'>Keep original labels
				</div>
				<div class='menu-group'>
					<input type='radio'    name='date-treatment' value='to-year'>Dates to years
					<input type='radio'    name='date-treatment' value='to-months'>Dates to month
					<input type='radio'    name='date-treatment' value='to-days'>Dates to days
				</div>
				<div class='menu-group'>
					<input type='radio'    name='date-baseline'  value='today' >Date baseline today
					<input type='radio'    name='date-baseline'  value='1900' >Date baseline 01-Jan-1900
					<input type='radio'    name='date-baseline'  value='2000' >Date baseline 01-Jan-2000
				</div>
				<div class='menu-group'>
					<input type='radio'    name='method' value='svmc'>SVM-C
					<input type='radio'    name='method' value='svmr'>SVM-R
					<input type='radio'    name='method' value='linear' checked>Linear Regression
					<input type='radio'    name='method' value='logistic' >Logistic Regression
					<input type='radio'    name='method' value='centroids' >Nearest Centroid
					<br/>
					<input type='radio'    name='method' value='correlation' >Correlation
					<input type='radio'    name='method' value='statistics' >Statistics
				</div>
			</form>
		</div>
	</div>

	<div id="main-area">
		<div id="results"> </div>
		<div id="blotter"> </div>
	</div>

	<script>
		window.addEventListener("load", function(e) {
			initUploadDivs()
			
			const menuSection = document.getElementById( "menu-section" ) ;
			const menuHamburger = menuSection.querySelector( ".hamburger" ) ;

			menuHamburger.addEventListener( "click", function(e) {
				toggleMenuCollapse() 
			}) ;
		});

		function toggleMenuCollapse() {
			const menuSection = document.getElementById( "menu-section" ) ;
			const collapsibles = menuSection.querySelectorAll( ".collapsible" ) ;
			for( var i=0 ; i<collapsibles.length ; i++ ) {
				collapsibles[i].classList.toggle("expanded");
			}
		}
		
		function initUploadDivs() {
			var divs = document.querySelectorAll(".upload");
			var div;
			for (var i = 0; i < divs.length; i++) {
				div = divs[i];
				div.addEventListener( "dragover", function(e) {
					e.preventDefault();
					e.dataTransfer.dropEffect = 'copy';
					e.target.classList.add( "dropok" ) ;
					return false;
				});
				div.addEventListener( "dragend", function(e) {
					e.preventDefault();
					e.target.classList.remove( "dropok" ) ;
					return false;
				});
				div.addEventListener( "dragleave", function(e) {
					e.preventDefault();
					e.target.classList.remove( "dropok" ) ;
					return false;
				});
				div.addEventListener( "drop", function(e) {
					e.stopPropagation()
					e.preventDefault()
					e.target.innerHTML = "Uploading ...." 
					e.target.classList.add( "active" ) 
					
					e.target.classList.remove( "dropok" ) 
					
					var u = e.dataTransfer.getData('url' ) ;
					if( u ) {
						document.getElementById("results").innerHTML = "Uploading urls like " + u + " isn't supported yet" ;						console.log( "Uploaded a url", u ) ;
						e.target.innerHTML = "Drop CSV" 
						e.target.classList.remove( "active" )
					} else {
						uploadFile( e.dataTransfer.files[0], e.target.dataset.target, e.target )
					}
					return false
				}) ;
			}
		}
		
		function uploadFile( file, target, div ) {
			// Will upload and send the controls info 
			// 
			const form = document.querySelector( ".control" ) ;
			var formData = new FormData( form );
			formData.append( file.name, file ) ;
			var xhr = new XMLHttpRequest();
			xhr.onload = function(e) {
				div.innerHTML = "Drop CSV" ;
				div.classList.remove( "active" )
				document.getElementById("results").innerHTML = "<pre>"
						+ e.target.responseText + "</pre>";
				toggleMenuCollapse()
				const o = JSON.parse( e.target.responseText ) ;
				drawCorrelations(o.R )  
			} ;
			xhr.onerror = function(e) {
				div.innerHTML = "Drop CSV" ;
				div.classList.remove( "active" )
				document.getElementById("results").innerHTML = "<pre>"
						+ e.target.responseText + "</pre>";
			} ;
			xhr.open("POST", target);
			xhr.send(formData);			
		}
		
		function drawCorrelations( R ) {
			const blotter = document.getElementById( "blotter" )
			while( blotter.hasChildNodes() ) {
				blotter.removeChild( blotter.lastChild )
			}
			const canvas = document.createElement( "canvas" ) 
			canvas.classList.add( "fill-blotter" )
			blotter.appendChild( canvas ) ;
			const ctx = canvas.getContext( "2d" )

			var dx = canvas.width / R.length
			var dy = canvas.height / R.length

			for( var i=0 ; i<R.length ; i++ ) {
				for( var j=0 ; j<R.length ; j++ ) {
					ctx.beginPath()
					const r = Math.round( Math.abs(R[i][j]) * 0xf).toString(16) 
					if( Math.abs(R[i][j]) > 0.9999999 ) {
						ctx.fillStyle = "#fff" 
					} else if( R[i][j]<0 ) {
						ctx.fillStyle = "#" +  r + "00" 
					} else {
						ctx.fillStyle = "#0" + r + "0" 
					}  
					ctx.fillRect( i*dx, j*dy, dx, dy ) 
					ctx.fill()
				} 
			} 
		}

</script>

	</script>
</body>
</html>